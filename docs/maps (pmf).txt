PMF - PlatinumSrc Map File/Format

- .pmf file extension
- Current version is 0.0
- All data should be little endian
- LZ4F should be used for compression

Format:

    <Header> <Data>

    Header:

        <char[3]: {'P', 'M', 'F'}>
        <u8: Major version>
        <<char[1..256]: {..., 0}>: Name>
        <<char[1..65536]: {..., 0}>: Description>
        <<char[1..65536]: {..., 0}>: Authors>
        <<char[1..256]: {..., 0}>: Compiler info>
        <<char[2..32]: {..., 0}>: Gamemode>
        <<u8: 0..31>: Extra gamemode count> [<char[2..32]: {..., 0}>: Gamemode name]...
        <u64: Creation time (the time at which the map finished compiling in UTC Unix seconds)>

    Data:

        <u32: Offset of <Extension table>>
        <u32: Size of <Map>> <Map>
        <Extension table>

        Extension table:
            <u32: Extension count> [u32: Offset of <Extension>]...
            [Extension]...
        Extension:
            (See 'map extensions.txt')
            <u8:
                <6 bits: 0>
                <1 bit: Use in CRC>
                <1 bit: Support required>
            >
            <<char[2..32]: {..., 0}>: Name>
            <u32: Data size>
            <u8[]: Data>

        Map:
            <u32: Offset of <Entity table>>
            <u32: Offset of <Level table>>
            <Entity table (see 'map entities.txt')>
            <Level table>

        Level table:
            <u32: Level count (must be at least 1)> <u32: Offset of <Level>>...
            <Level>...
        Level:
            <u32: Offset of <String table>>
            <u32: Offset of <Client level data>>
            <u32: Offset of <Server level data>>
            <u32: Offset of <Chunk table>>
            <u16: Material count> <u32: Offset of first <Material>>
            <u16: Physics material count> <u32: Offset of first <Physics material>> <u16: Air physics material>
            <u16: Sound material count> <u32: Offset of first <Sound material>>
            <u8: Weather environment count> <u32: Offset of first <Weather environment>> <u8: Default weather environment>
            <u8: Gravity environment count> <u32: Offset of first <Gravity environment>> <u8: Default gravity environment>
            <String table>
            [Material]...
            [Physics material]...
            [Sound material]...
            [Weather environment]...
            [Gravity environment]...
            <Client level data>
            <Server level data>
            <Chunk table>
            <Client level data>
            <Server level data>
        Client level data:
            <u32: Offset of <String table>>
            <u32: Offset of first <Client-side material>>
            <u8: Sound environment count> <u32: Offset of first <Sound environment>> <u8: Default sound environment>
            <u8: Sky environment count> <u32: Offset of first <Sky environment>> <u8: Default sky environment>
            <String table>
            [Client-side material]...
            [Sound environment]...
            [Sky environment]...
        Server level data:
            <u32: Offset of <Entity table>>
            <Entity table (see 'map entities.txt')>

        Sound environment:
            <<String>: Name>
            <float: Low pass filter>
            <float: High pass filter>
            <float: Reverb delay>
            <float: Reverb feedback>
            <float: Reverb mix>
            <float: Reverb low pass filter>
            <float: Reverb high pass filter>
        Weather environment:
            <<String>: Name>
            <float[3]: XYZ wind direction and velocity>
            <u32: Wind direction random seed>
            <float[3]: XYZ wind direction randomness>
            <float: Wind direction noise speed>
            <u32: Wind velocity random seed>
            <float: Wind velocity randomness>
            <float: Wind velocity noise speed>
        Sky environment:
            <<String>: Name>
            <<String>: +X skybox material>
            <<String>: +Y skybox material>
            <<String>: +Z skybox material>
            <<String>: -X skybox material>
            <<String>: -Y skybox material>
            <<String>: -Z skybox material>
            <<String>: Top cloud layer material (empty for none)>
            <<String>: Bottom cloud layer material (empty for none)>
            <u32: Offset of 3D skybox <Chunk table> (0 for none)>
        Gravity environment:
            <<String>: Name>
            <float[3]: XYZ gravity>

        Chunk table:
            <u8: Chunk size (2^n)>
            <u32:
                <8 bits: Chunk Y count minus 1>
                <12 bits: Chunk X count minus 1>
                <12 bits: Chunk Z count minus 1>
            >
            <<World coordinate>: Center>
            <u32: Offset of <Chunk> (ordered by [Y][X][Z])>...
            <Chunk>...
        Chunk:
            <u32: Offset of <String table>>
            <u32: Offset of <Client chunk data>>
            <u32: Offset of <Server chunk data>>
            <u32: Offset of <Static entity table>>
            <u8: Region count> <u32: Offset of first <Region>>
            <u8: Used material count> <u32: Offset of first <Material> index>
            <u8: Used physics material count> <u32: Offset of first <Physics material> index>
            <u8: Used sound material count> <u32: Offset of first <Sound material> index>
            <u8: Weather environment area count> <u32: Offset of first weather <Environment area>>
            <u8: Gravity environment area count> <u32: Offset of first gravity <Environment area>>
            <u8: Dynamic light count> <u32: Offset of first <Dynamic light>>
            <u8: Fast light count> <u32: Offset of first <Fast light>>
            <u32: Cube count (must be at least 1)> <u32: Size of <Compressed <Cube>...>> <u32: Offset of <Compressed <Cube>...>>
            [Region]...
            [u16: Material index]...
            [u16: Physics material index]...
            [u16: Sound material index]...
            [<Environment area>: Weather environment area]...
            [<Environment area>: Gravity environment area]...
            [Dynamic light]...
            [Fast light]...
            <Compressed <Cube>...>
            <String table>
            <Client chunk data>
            <Server chunk data>
            <Static entity table (see 'map entities.txt')>
        Client chunk data:
            <u8: Sound environment area count> <u32: Offset of first sound <Environment area>>
            <u8: Sky environment area count> <u32: Offset of first sky <Environment area>>
            <u32: Index count> <u32: Offset of first <u32: Index>>
            <u32: Vertex count> <u32: Offset of first <Vertex>>
            <u8: Lightmap count> <u32: Offset of first <Lightmap>>
            <u32: Offset of first <Client-side dynamic light>>
            <u32: Offset of first <Client-side fast light>>
            <u32: Size of <Compressed <Client-side cube>...>> <u32: Offset of <Compressed <Client-side cube>...>>
            [<Environment area>: Sound environment area]...
            [<Environment area>: Sky environment area]...
            [u32: Index]...
            [Vertex]...
            [Lightmap]...
            [Client-side dynamic light]...
            [Client-side fast light]...
            <Compressed <Client-side cube>...>
        Server chunk data:
            <u32: Offset of <Entity table>>
            <Entity table (see 'map entities.txt')>

        World coordinate:
            <<Chunk index>: Chunk>
            <float[3]: In-chunk position>
        Chunk index:
            <u32:
                <8 bits: Chunk Y>
                <12 bits: Chunk X>
                <12 bits: Chunk Z>
            >

        Region:
            <float[3]: (+X, +Y, +Z) corner>
            <float[3]: (-X, -Y, -Z) corner>
            <u32: Other active chunk count> [Chunk index]...

        Environment area:
            <float[3]: (+X, +Y, +Z) corner offset>
            <float[3]: (-X, +Y, +Z) corner offset>
            <float[3]: (+X, +Y, -Z) corner offset>
            <float[3]: (-X, +Y, -Z) corner offset>
            <float[3]: (+X, -Y, +Z) corner offset>
            <float[3]: (-X, -Y, +Z) corner offset>
            <float[3]: (+X, -Y, -Z) corner offset>
            <float[3]: (-X, -Y, -Z) corner offset>
            <<String>: Environment name>

        Material:
            <<String>: Name>
            <u8: User-defined type>
            <u8:
                <6 bits: 0>
                <1 bit: Liquid>
                <1 bit: Transparent>
            >
        Client-side material:
            <u8: 
                { ENTMAT_RENDMODE_NORMAL
                | ENTMAT_RENDMODE_ADD }
            >
            <u8[3]: RGB color>
            <u8: Alpha (ignored if 'transparent' bit is not set)>
            <u8[3]: RGB emission>
            <u8: Shading>
            <<String>: Texture (none if empty)>
            <<String>: Detail texture (none if empty)>
            <<String>: Matcap texture (none if empty)>
            <u8: Extra texture count> <<String table offset>: Offset of first extra texture <String>>
            <u32: Texture advance time in microseconds>
            <float[2]: Texture UV scroll per second>
            <float[2]: Detail texture UV scroll per second>
            <float[2]: Matcap texture UV scroll per second>
            [Client-side material wave info (only present if 'liquid' bit is set)]
        Client-side material wave info:
            <float[2]: Velocity>
            <float: Height>
            <float: Scale>
            <float: Wind influence>

        Physics material:
            <<String>: Name>
            <u8:
                <7 bits: 0>
                <1 bit: Not solid>
            >
            <float: Friction (if 'not solid' bit is not set) or max speed (if 'not solid' bit is set)>
            <float: Traction (ignored if 'not solid' bit is set)>
            <float: Bounce (ignored if 'not solid' bit is set)>
            <float: Minimum speed to cause damage>
            <float: Base damage>
            <float: Extra damage per meter per second>

        Sound material:
            <float: Range dampening>
            <float: Volume dampening>
            <float: Frequency dampening>

        Vertex:
            <float[3]: XYZ>
            <float[3]: Normal XYZ>
            <float[2]: Texture UV>
            <float[2]: Lightmap UV>

        Lightmap:
            <u8: <4 bits: Height (2^n)> <4 bits: Width (2^n)>>
            <u32: Compressed size>
            <u8: Compressed <u8[3]: RGB luxel>...>

        Dynamic light:
            <u8:
                <6 bits: 0>
                <1 bit: Preserve>
                <1 bit: Enabled>
            >
            <u32: Global ID>
        Client-side dynamic light:
            <u8[3]: RGB color>
            <u8: Affected lightmap count>
            <Client-side dynamic light lightmap>...
        Client-side dynamic light lightmap
            <u8: Lightmap>
            <u32: Compressed size>
            <u8: Compressed <u8[3]: RGB luxel>...>

        Fast light:
            <u8:
                <6 bits: 0>
                <1 bit: Preserve>
                <1 bit: Enabled>
            >
            <u8: Initial intensity>
            <u32: Global ID>
        Client-side fast light:
            <u8[3]: RGB color>
            <u32: Range count>
            <
                <u32: Vertices to skip>
                <u32: Multiplier count> <u8: Multiplier>...
            >...

        Cube table:
            <u32: Cube count (must be at least 1)>
            <u32: Size of <Compressed <Cube>...>>
            <Compressed <Cube>...>
        Cube:
            <u8:
                <4 bits:
                    { 0
                    | <Geometry cube bits>
                    | <Extended geometry cube bits>
                    | <Visibility info cube bits>
                    | <Pathfinding info cube bits> }
                >
                <4 bits:
                    { PMF_CUBE_EMPTY
                    | PMF_CUBE_PARENT
                    | PMF_CUBE_GEOM
                    | PMF_CUBE_EXTGEOM
                    | PMF_CUBE_VISINFO
                    | PMF_CUBE_LIGHTINFO
                    | PMF_CUBE_PATHINFO
                    | PMF_CUBE_COLL }
                >
            >
            [
                { <Parent cube data>
                | <Geometry cube data>
                | <Extended geometry cube data>
                | <Visibility info cube data>
                | <Pathfinding info cube data>
                | <Collider cube data> }
            ]

        Client-side cube table:
            <u32: Size of <Compressed <Client-side cube>...>>
            <Compressed <Client-side cube>...>
        Client-side cube:
            [
                { <Client-side Geometry cube data>
                | <Client-side Extended geometry cube data>
                | <Lighting info cube data> }
            ]

        Parent cube data:
            <u32: (+X, +Y, +Z) child index> <u32: (-X, +Y, +Z) child index>
            <u32: (+X, +Y, -Z) child index> <u32: (-X, +Y, -Z) child index>
            <u32: (+X, -Y, +Z) child index> <u32: (-X, -Y, +Z) child index>
            <u32: (+X, -Y, -Z) child index> <u32: (-X, -Y, -Z) child index>

        Geometry cube data:
            <u8: Material>
            <u8: Physics material>
            <u8: Sound material>
        Client-side geometry cube data:
            <u32:
                <4 bits: -Z # of triangles> <4 bits: -Y # of triangles>
                <4 bits: -X # of triangles> <4 bits: +Z # of triangles>
                <4 bits: +Y # of triangles> <4 bits: +X # of triangles>
                <u8: Lightmap>
            >
            <u32: Index of first index>
        Geometry cube bits:
            <2 bits: 0>
            <1 bit: No collision>
            <1 bit: Draw backfaces>

        Extended geometry cube data:
            <u8: +X material> <u8: +Y material> <u8: +Z material>
            <u8: -X material> <u8: -Y material> <u8: -Z material>
            <u8: +X physics material> <u8: +Y physics material> <u8: +Z physics material>
            <u8: -X physics material> <u8: -Y physics material> <u8: -Z physics material>
            <u8: Sound material>
        Client-side extended geometry cube data:
            <u8: Lightmap>
            <u8: +X # of triangles> <u8: +Y # of triangles> <u8: +Z # of triangles>
            <u8: -X # of triangles> <u8: -Y # of triangles> <u8: -Z # of triangles>
            <u32: Index of first index>
        Extended geometry cube bits:
            <2 bits: 0>
            <1 bit: No collision>
            <1 bit: Draw backfaces>

        Visibility info cube data:
            <u32: Child or additional visibility info index>
            <Chunk index>
            <u32[16]: Cube indices>
            <i8[16]: Cube depths>
        Visibility info cube bits:
            <4 bits: Cube count minus 1>

        Lighting info cube data:
            <u32: Child or additional lighting info index>
            <u8[3]: Base light>
            <u8:
                <4 bits: Dynamic light count>
                <4 bits: Fast light count>
            >
            <<Lighting info cube light reference>[15]: Dynamic lights>
            <<Lighting info cube light reference>[15]: Fast lights>
        Lighting info cube light reference:
            <u8: Index>
            <u8: Multiplier>

        Pathfinding info cube data:
            <u32: Child or additional pathfinding info index>
            <<Pathfinding info cube attribute>[16]>
        Pathfinding info cube attribute:
            <<String>: Name>
            <<String>: Data>
        Pathfinding info cube bits:
            <4 bits: Attribute count minus 1>

        Collider cube data:
            <u32: Child or additional collider index>
            <float[3]: (+X, +Y, +Z) XYZ> <float[3]: (-X, +Y, +Z) XYZ>
            <float[3]: (+X, +Y, -Z) XYZ> <float[3]: (-X, +Y, -Z) XYZ>
            <float[3]: (+X, -Y, +Z) XYZ> <float[3]: (-X, -Y, +Z) XYZ>
            <float[3]: (+X, -Y, -Z) XYZ> <float[3]: (-X, -Y, -Z) XYZ>

        String table:
            <u32: Uncompressed size>
            <u32: Compressed size>
            <u8[]: Compressed data>
        String table offset:
            <u32: Offset in decompressed respective string table>
        String:
            <<String table offset>: Offset of null-terminated string>


